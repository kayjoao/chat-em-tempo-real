<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bate-papo em Tempo Real</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Day.js para formatar datas -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <style>
        /* Estilos personalizados para a barra de rolagem e transições */
        #chat-messages::-webkit-scrollbar, #user-list::-webkit-scrollbar {
            width: 8px;
        }
        #chat-messages::-webkit-scrollbar-track, #user-list::-webkit-scrollbar-track {
            background: #1a202c;
        }
        #chat-messages::-webkit-scrollbar-thumb, #user-list::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }
        .transition-all {
            transition: all 0.3s ease-in-out;
        }
        #sidebar, #private-message-indicator {
            transition: all 0.3s ease-in-out;
        }
        .private-chat-trigger {
            cursor: pointer;
            text-decoration: underline;
            font-weight: bold;
        }
        .private-chat-trigger:hover {
            color: #2dd4bf; /* Cor cyan-400 do Tailwind */
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans flex items-center justify-center min-h-screen overflow-hidden">

    <div id="app-container" class="w-full max-w-4xl h-[90vh] mx-auto bg-gray-800 shadow-2xl rounded-xl flex flex-col p-4 md:p-6 relative overflow-hidden">

        <!-- Tela de Login -->
        <div id="login-screen" class="flex flex-col items-center justify-center h-full">
            <div class="w-full max-w-sm text-center">
                <h1 class="text-4xl font-bold text-cyan-400 mb-2">Bem-vindo ao Chat!</h1>
                <p class="text-gray-400 mb-8">Escolha um apelido para começar.</p>
                <input type="text" id="nickname-input" placeholder="Digite seu apelido..." class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 mb-4" maxlength="20">
                <button id="join-button" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                    Entrar no Bate-papo
                </button>
                <p id="error-message" class="text-red-400 mt-4 h-4"></p>
            </div>
        </div>

        <!-- Tela de Chat -->
        <div id="chat-screen" class="hidden flex-1 flex flex-col h-full overflow-hidden">
            <header class="border-b-2 border-gray-700 pb-4 mb-4 flex items-center justify-between">
                <button id="sidebar-toggle" class="p-2 rounded-md hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                </button>
                <div class="text-center">
                    <h2 class="text-2xl font-bold text-cyan-400">Sala de Bate-papo</h2>
                    <p class="text-sm text-gray-400">Como: <strong id="nickname-display" class="text-cyan-300"></strong></p>
                </div>
                <div class="w-10"></div>
            </header>

            <div id="chat-messages" class="flex-1 overflow-y-auto pr-2 space-y-4"></div>

            <div class="mt-4 pt-4 border-t-2 border-gray-700">
                <div id="private-message-indicator" class="hidden h-8 items-center justify-between bg-teal-800 text-white px-3 py-1 rounded-t-lg text-sm">
                    <span>Enviando mensagem privada para: <strong id="private-target-nickname"></strong></span>
                    <button id="cancel-private-button" class="font-bold text-lg">×</button>
                </div>
                <div class="flex items-center space-x-3">
                    <input type="text" id="message-input" placeholder="Digite sua mensagem..." class="flex-1 px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-cyan-500">
                    <button id="send-button" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold p-3 rounded-full shadow-lg transition-transform transform hover:scale-110">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Sidebar e Overlay -->
        <div id="overlay" class="hidden absolute inset-0 bg-black bg-opacity-50 z-10"></div>
        <aside id="sidebar" class="absolute top-0 left-0 h-full w-64 bg-gray-900 p-4 transform -translate-x-full z-20">
            <h3 class="text-xl font-bold text-cyan-400 border-b border-gray-700 pb-2 mb-4">Usuários na Sala</h3>
            <ul id="user-list" class="space-y-2 overflow-y-auto h-[calc(100%-50px)]"></ul>
        </aside>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAÇÃO DO FIREBASE INSERIDA ---
        const firebaseConfig = {
            apiKey: "AIzaSyBNxeLZtHNvv4VIo5GW-azCdwB0PshDgb8",
            authDomain: "bate-papo-5d433.firebaseapp.com",
            projectId: "bate-papo-5d433",
            storageBucket: "bate-papo-5d433.appspot.com",
            messagingSenderId: "884947581783",
            appId: "1:884947581783:web:c0ef1f875528ef1d7e1c12",
            measurementId: "G-02EK8053D0"
        };

        // --- ELEMENTOS DA UI ---
        const loginScreen = document.getElementById('login-screen'),
              chatScreen = document.getElementById('chat-screen'),
              nicknameInput = document.getElementById('nickname-input'),
              joinButton = document.getElementById('join-button'),
              errorMessage = document.getElementById('error-message'),
              nicknameDisplay = document.getElementById('nickname-display'),
              chatMessages = document.getElementById('chat-messages'),
              messageInput = document.getElementById('message-input'),
              sendButton = document.getElementById('send-button'),
              sidebar = document.getElementById('sidebar'),
              sidebarToggle = document.getElementById('sidebar-toggle'),
              overlay = document.getElementById('overlay'),
              userList = document.getElementById('user-list'),
              privateIndicator = document.getElementById('private-message-indicator'),
              privateTargetNickname = document.getElementById('private-target-nickname'),
              cancelPrivateButton = document.getElementById('cancel-private-button');

        // --- ESTADO DA APLICAÇÃO ---
        let userNickname = '', currentUserId = null, presenceDocId = null;
        let privateMessageTarget = null;
        let db, auth;

        // --- INICIALIZAÇÃO ---
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("Firebase inicializado com sucesso!");
            authenticateUser();
        } catch (error) {
            console.error("Erro Crítico na Inicialização do Firebase:", error);
            errorMessage.textContent = "Erro de configuração. Verifique o console.";
        }

        // --- FUNÇÕES ---
        async function authenticateUser() {
            try {
                await signInAnonymously(auth);
                auth.onAuthStateChanged(user => {
                    if (user) {
                        currentUserId = user.uid;
                        console.log("Usuário autenticado com UID:", currentUserId);
                        listenForMessages();
                        listenForUsers();
                    } else {
                        console.error("Autenticação anônima falhou.");
                        errorMessage.textContent = "Não foi possível conectar ao chat.";
                    }
                });
            } catch (error) {
                console.error("Erro na autenticação:", error);
                errorMessage.textContent = "Erro de autenticação.";
            }
        }

        async function joinChat() {
            const nick = nicknameInput.value.trim();
            if (!nick) {
                errorMessage.textContent = "Por favor, insira um apelido.";
                return;
            }
            if (!currentUserId) {
                errorMessage.textContent = "Aguardando conexão com o servidor...";
                console.error("Tentativa de entrar sem um User ID. A autenticação pode ter falhado.");
                return;
            }
            
            errorMessage.textContent = "";
            userNickname = nick;
            nicknameDisplay.textContent = userNickname;
            
            const appId = firebaseConfig.appId;
            const presenceCollectionPath = `artifacts/${appId}/public/data/presence`;
            const messagesCollectionPath = `artifacts/${appId}/public/data/messages`;
            
            try {
                const docRef = await addDoc(collection(db, presenceCollectionPath), { uid: currentUserId, nickname: userNickname });
                presenceDocId = docRef.id;
                
                await addDoc(collection(db, messagesCollectionPath), {
                    type: 'system',
                    text: `${userNickname} entrou na sala.`,
                    timestamp: serverTimestamp(),
                    userId: currentUserId,
                    nickname: userNickname
                });

                loginScreen.classList.add('hidden');
                chatScreen.classList.remove('hidden');
                messageInput.focus();
            } catch (error) {
                console.error("Erro ao entrar no chat (verifique as regras do Firestore):", error);
                errorMessage.textContent = "Erro ao entrar na sala. Verifique as permissões.";
            }
        }
        
        async function sendMessage() {
            const text = messageInput.value.trim();
            if (text === '' || !currentUserId) return;

            const appId = firebaseConfig.appId;
            const messagesCollectionPath = `artifacts/${appId}/public/data/messages`;

            const messageData = {
                text: text,
                nickname: userNickname,
                userId: currentUserId,
                timestamp: serverTimestamp(),
            };

            if (privateMessageTarget) {
                messageData.type = 'private';
                messageData.toUserId = privateMessageTarget.uid;
                messageData.toNickname = privateMessageTarget.nickname;
            } else {
                messageData.type = 'public';
            }

            try {
                await addDoc(collection(db, messagesCollectionPath), messageData);
                messageInput.value = '';

