<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bate-papo em Tempo Real (Depuração)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Day.js para formatar datas -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <style>
        /* Estilos personalizados */
        #chat-messages::-webkit-scrollbar, #user-list::-webkit-scrollbar { width: 8px; }
        #chat-messages::-webkit-scrollbar-track, #user-list::-webkit-scrollbar-track { background: #1a202c; }
        #chat-messages::-webkit-scrollbar-thumb, #user-list::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        .transition-all { transition: all 0.3s ease-in-out; }
        .private-chat-trigger { cursor: pointer; text-decoration: underline; font-weight: bold; }
        .private-chat-trigger:hover { color: #2dd4bf; }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans flex items-center justify-center min-h-screen overflow-hidden">

    <div id="app-container" class="w-full max-w-4xl h-[90vh] mx-auto bg-gray-800 shadow-2xl rounded-xl flex flex-col p-4 md:p-6 relative overflow-hidden">

        <!-- Tela de Login -->
        <div id="login-screen" class="flex flex-col items-center justify-center h-full">
            <div class="w-full max-w-sm text-center">
                <h1 class="text-4xl font-bold text-cyan-400 mb-2">Bem-vindo ao Chat!</h1>
                <p class="text-gray-400 mb-8">Escolha um apelido para começar.</p>
                <input type="text" id="nickname-input" placeholder="Digite seu apelido..." class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 mb-4" maxlength="20">
                <button id="join-button" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                    Entrar no Bate-papo
                </button>
                <p id="error-message" class="text-red-400 mt-4 h-auto min-h-[1rem] break-words"></p>
            </div>
        </div>

        <!-- Tela de Chat (continua igual) -->
        <div id="chat-screen" class="hidden flex-1 flex flex-col h-full overflow-hidden">
            <header class="border-b-2 border-gray-700 pb-4 mb-4 flex items-center justify-between">
                <button id="sidebar-toggle" class="p-2 rounded-md hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                </button>
                <div class="text-center">
                    <h2 class="text-2xl font-bold text-cyan-400">Sala de Bate-papo</h2>
                    <p class="text-sm text-gray-400">Como: <strong id="nickname-display" class="text-cyan-300"></strong></p>
                </div>
                <div class="w-10"></div>
            </header>
            <div id="chat-messages" class="flex-1 overflow-y-auto pr-2 space-y-4"></div>
            <div class="mt-4 pt-4 border-t-2 border-gray-700">
                <div id="private-message-indicator" class="hidden h-8 items-center justify-between bg-teal-800 text-white px-3 py-1 rounded-t-lg text-sm">
                    <span>Enviando mensagem privada para: <strong id="private-target-nickname"></strong></span>
                    <button id="cancel-private-button" class="font-bold text-lg">×</button>
                </div>
                <div class="flex items-center space-x-3">
                    <input type="text" id="message-input" placeholder="Digite sua mensagem..." class="flex-1 px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-cyan-500">
                    <button id="send-button" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold p-3 rounded-full shadow-lg transition-transform transform hover:scale-110">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </div>
            </div>
        </div>
        <div id="overlay" class="hidden absolute inset-0 bg-black bg-opacity-50 z-10"></div>
        <aside id="sidebar" class="absolute top-0 left-0 h-full w-64 bg-gray-900 p-4 transform -translate-x-full z-20">
            <h3 class="text-xl font-bold text-cyan-400 border-b border-gray-700 pb-2 mb-4">Usuários na Sala</h3>
            <ul id="user-list" class="space-y-2 overflow-y-auto h-[calc(100%-50px)]"></ul>
        </aside>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAÇÃO DO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBNxeLZtHNvv4VIo5GW-azCdwB0PshDgb8",
            authDomain: "bate-papo-5d433.firebaseapp.com",
            projectId: "bate-papo-5d433",
            storageBucket: "bate-papo-5d433.appspot.com",
            messagingSenderId: "884947581783",
            appId: "1:884947581783:web:c0ef1f875528ef1d7e1c12",
            measurementId: "G-02EK8053D0"
        };

        // --- ELEMENTOS DA UI ---
        const loginScreen = document.getElementById('login-screen'),
              chatScreen = document.getElementById('chat-screen'),
              nicknameInput = document.getElementById('nickname-input'),
              joinButton = document.getElementById('join-button'),
              errorMessage = document.getElementById('error-message'),
              nicknameDisplay = document.getElementById('nickname-display'),
              chatMessages = document.getElementById('chat-messages'),
              messageInput = document.getElementById('message-input'),
              sendButton = document.getElementById('send-button'),
              sidebar = document.getElementById('sidebar'),
              sidebarToggle = document.getElementById('sidebar-toggle'),
              overlay = document.getElementById('overlay'),
              userList = document.getElementById('user-list'),
              privateIndicator = document.getElementById('private-message-indicator'),
              privateTargetNickname = document.getElementById('private-target-nickname'),
              cancelPrivateButton = document.getElementById('cancel-private-button');

        // --- ESTADO DA APLICAÇÃO ---
        let userNickname = '', currentUserId = null, presenceDocId = null;
        let privateMessageTarget = null;
        let db, auth;

        // --- INICIALIZAÇÃO ---
        try {
            errorMessage.textContent = "A inicializar a ligação...";
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("DEBUG: Firebase App inicializado.");
            errorMessage.textContent = "Ligação inicializada. A autenticar...";
            authenticateUser();
        } catch (error) {
            console.error("ERRO CRÍTICO: Falha na inicialização do Firebase. Verifique o objeto firebaseConfig.", error);
            errorMessage.textContent = "ERRO: A configuração do Firebase está incorreta.";
        }

        // --- FUNÇÕES ---
        async function authenticateUser() {
            try {
                console.log("DEBUG: A tentar autenticação anónima...");
                await signInAnonymously(auth);
                auth.onAuthStateChanged(user => {
                    if (user) {
                        currentUserId = user.uid;
                        console.log("SUCESSO: Autenticado com UID:", currentUserId);
                        errorMessage.textContent = "Conectado. Pode entrar.";
                        // Funções que dependem da autenticação
                        listenForMessages();
                        listenForUsers();
                    } else {
                        console.error("ERRO: O objeto 'user' da autenticação é nulo. Verifique se a Autenticação Anónima está ativa no Firebase.");
                        errorMessage.textContent = "ERRO: Falha na autenticação. Ative o login anónimo no Firebase.";
                    }
                });
            } catch (error) {
                console.error("ERRO: Falha em signInAnonymously().", error);
                errorMessage.textContent = `ERRO de Auth: ${error.code}`;
            }
        }

        async function joinChat() {
            console.log("DEBUG: Função joinChat() chamada.");
            const nick = nicknameInput.value.trim();
            if (!nick) {
                errorMessage.textContent = "Por favor, insira um apelido.";
                return;
            }
            if (!currentUserId) {
                errorMessage.textContent = "Ainda a conectar... Por favor, aguarde um momento.";
                console.error("ERRO: Tentativa de entrar sem currentUserId. A autenticação pode não ter sido concluída ou falhou.");
                return;
            }
            
            console.log(`DEBUG: A tentar entrar com o apelido "${nick}" e UID "${currentUserId}"`);
            errorMessage.textContent = `A entrar como ${nick}...`;
            userNickname = nick;
            nicknameDisplay.textContent = userNickname;
            
            const appId = firebaseConfig.appId;
            const presenceCollectionPath = `artifacts/${appId}/public/data/presence`;
            const messagesCollectionPath = `artifacts/${appId}/public/data/messages`;
            
            try {
                // Adicionar presença
                console.log("DEBUG: A adicionar documento à coleção de presença...");
                const docRef = await addDoc(collection(db, presenceCollectionPath), { uid: currentUserId, nickname: userNickname });
                presenceDocId = docRef.id;
                console.log("SUCESSO: Presença adicionada com ID:", presenceDocId);

                // Enviar mensagem de sistema
                console.log("DEBUG: A enviar mensagem de sistema...");
                await addDoc(collection(db, messagesCollectionPath), {
                    type: 'system', text: `${userNickname} entrou na sala.`,
                    timestamp: serverTimestamp(), userId: currentUserId, nickname: userNickname
                });
                console.log("SUCESSO: Mensagem de sistema enviada.");

                // Mudar de ecrã
                loginScreen.classList.add('hidden');
                chatScreen.classList.remove('hidden');
                messageInput.focus();

            } catch (error) {
                console.error("ERRO CRÍTICO ao entrar no chat. Provavelmente um problema com as Regras de Segurança do Firestore.", error);
                errorMessage.textContent = `ERRO ao entrar: ${error.message}. Verifique as Regras de Segurança do Firestore.`;
            }
        }
        
        // O resto do código permanece igual
        async function sendMessage() {const text = messageInput.value.trim();if (text === '' || !currentUserId) return;const appId = firebaseConfig.appId;const messagesCollectionPath = `artifacts/${appId}/public/data/messages`;const messageData = {text: text,nickname: userNickname,userId: currentUserId,timestamp: serverTimestamp(),};if (privateMessageTarget) {messageData.type = 'private';messageData.toUserId = privateMessageTarget.uid;messageData.toNickname = privateMessageTarget.nickname;} else {messageData.type = 'public';}try {await addDoc(collection(db, messagesCollectionPath), messageData);messageInput.value = '';} catch (error) {console.error("Erro ao enviar mensagem:", error);}}
        function listenForMessages() {const appId = firebaseConfig.appId;const messagesCollectionPath = `artifacts/${appId}/public/data/messages`;const q = query(collection(db, messagesCollectionPath), orderBy("timestamp", "asc"));onSnapshot(q, (snapshot) => {snapshot.docChanges().forEach((change) => {if (change.type === "added") {displayMessage(change.doc.data());}});if (chatMessages.children.length > 0) {chatMessages.scrollTop = chatMessages.scrollHeight;}}, (error) => console.error("Erro ao receber mensagens:", error));}
        function displayMessage(msg) {let messageElement;switch (msg.type) {case 'system':messageElement = createSystemMessageElement(msg);break;case 'private':if (msg.userId === currentUserId || msg.toUserId === currentUserId) {messageElement = createPrivateMessageElement(msg);}break;default:messageElement = createPublicMessageElement(msg);break;}if (messageElement) {chatMessages.appendChild(messageElement);}}
        function createPublicMessageElement(msg) {const isMyMessage = msg.userId === currentUserId;const wrapper = document.createElement('div');wrapper.className = `flex ${isMyMessage ? 'justify-end' : 'justify-start'}`;const bubble = document.createElement('div');bubble.className = `max-w-xs md:max-w-md lg:max-w-lg px-4 py-2 rounded-xl shadow-md ${isMyMessage ? 'bg-cyan-700 rounded-br-none' : 'bg-gray-600 rounded-bl-none'}`;bubble.innerHTML = `<p class="font-bold text-sm ${isMyMessage ? 'text-cyan-200' : 'text-gray-300'}">${msg.nickname}</p><p class="text-white break-words">${msg.text}</p><p class="text-xs text-gray-400 text-right mt-1">${msg.timestamp ? dayjs(msg.timestamp.toDate()).format('HH:mm') : ''}</p>`;wrapper.appendChild(bubble);return wrapper;}
        function createSystemMessageElement(msg) {const wrapper = document.createElement('div');wrapper.className = 'text-center my-2';const text = document.createElement('p');text.className = 'text-sm text-gray-500 italic';const messageText = msg.text.replace(msg.nickname, `<span class="private-chat-trigger" data-uid="${msg.userId}" data-nickname="${msg.nickname}">${msg.nickname}</span>`);text.innerHTML = messageText;wrapper.appendChild(text);return wrapper;}
        function createPrivateMessageElement(msg) {const isMyMessage = msg.userId === currentUserId;const wrapper = document.createElement('div');wrapper.className = `flex ${isMyMessage ? 'justify-end' : 'justify-start'}`;const bubble = document.createElement('div');bubble.className = `max-w-xs md:max-w-md lg:max-w-lg px-4 py-2 rounded-xl shadow-md border ${isMyMessage ? 'bg-teal-800 border-teal-600 rounded-br-none' : 'bg-gray-700 border-gray-500 rounded-bl-none'}`;let headerText = isMyMessage ? `(Privado para ${msg.toNickname})` : `(Privado de ${msg.nickname})`;bubble.innerHTML = `<p class="font-bold text-sm text-teal-300">${headerText}</p><p class="text-white break-words mt-1">${msg.text}</p><p class="text-xs text-gray-400 text-right mt-1">${msg.timestamp ? dayjs(msg.timestamp.toDate()).format('HH:mm') : ''}</p>`;wrapper.appendChild(bubble);return wrapper;}
        function listenForUsers() {const appId = firebaseConfig.appId;const presenceCollectionPath = `artifacts/${appId}/public/data/presence`;const q = query(collection(db, presenceCollectionPath));onSnapshot(q, (snapshot) => {userList.innerHTML = '';snapshot.forEach((doc) => {const user = doc.data();const userItem = document.createElement('li');userItem.className = 'flex items-center space-x-2 text-gray-300';userItem.innerHTML = `<span class="w-2 h-2 bg-green-400 rounded-full"></span><span>${user.nickname}</span>`;userList.appendChild(userItem);});});}
        function setPrivateMessageTarget(target) {if (target.uid === currentUserId) {cancelPrivateMessageMode();return;}privateMessageTarget = target;privateTargetNickname.textContent = target.nickname;privateIndicator.classList.remove('hidden');privateIndicator.classList.add('flex');messageInput.focus();}
        function cancelPrivateMessageMode() {privateMessageTarget = null;privateIndicator.classList.add('hidden');privateIndicator.classList.remove('flex');}
        async function handleUserExit() {if (presenceDocId) {const appId = firebaseConfig.appId;const presenceCollectionPath = `artifacts/${appId}/public/data/presence`;await deleteDoc(doc(db, presenceCollectionPath, presenceDocId));}}
        function toggleSidebar() {sidebar.classList.toggle('-translate-x-full');overlay.classList.toggle('hidden');}

        // --- EVENT LISTENERS ---
        joinButton.addEventListener('click', joinChat);
        nicknameInput.addEventListener('keypress', (e) => e.key === 'Enter' && joinChat());
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), sendMessage()));
        sidebarToggle.addEventListener('click', toggleSidebar);
        overlay.addEventListener('click', toggleSidebar);
        cancelPrivateButton.addEventListener('click', cancelPrivateMessageMode);
        chatMessages.addEventListener('click', (e) => {if (e.target.classList.contains('private-chat-trigger')) {const { uid, nickname } = e.target.dataset;setPrivateMessageTarget({ uid, nickname });}});

